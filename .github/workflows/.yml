name: PMD Static Analysis

on:
  push:
    branches:
      - '**'

jobs:
  pmd-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Install PMD 7.8.0
        run: |
          curl -sL https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.8.0/pmd-dist-7.8.0-bin.zip -o pmd.zip
          unzip -q pmd.zip
          echo "$PWD/pmd-bin-7.8.0/bin" >> $GITHUB_PATH
          pmd --version

      - name: Run PMD on HTML files
        id: html
        run: |
          set +e
          pmd check \
            -f text \
            -R .github/rulesets/html.xml \
            -d . \
            --exclude node_modules/** \
            --exclude .git/**

          echo "exit_code=$?" >> $GITHUB_OUTPUT
          exit 0

      - name: Run PMD on JS files
        id: js
        run: |
          set +e
          pmd check \
            -f text \
            -R .github/rulesets/js.xml \
            -d . \
            --exclude node_modules/** \
            --exclude .git/**

          echo "exit_code=$?" >> $GITHUB_OUTPUT
          exit 0

      - name: Evaluate PMD results
        run: |
          if [ "${{ steps.html.outputs.exit_code }}" -eq 4 ] || \
             [ "${{ steps.js.outputs.exit_code }}" -eq 4 ]; then
            echo "PMD violations detected."
            exit 1
          fi

          echo "All PMD checks passed."
