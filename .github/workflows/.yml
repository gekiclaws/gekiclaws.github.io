name: PMD Static Analysis

on:
  push: # Run on all branches for push events
    branches:
      - '**'

jobs:
  pmd-check:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Java (required for PMD)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '21' # PMD requires Java 11 or higher
          distribution: 'temurin' # Use Eclipse Temurin as the Java distribution

      # Download and install PMD 7.8.0
      - name: Install PMD
        run: |
          cd $HOME
          curl -OL https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.8.0/pmd-dist-7.8.0-bin.zip
          unzip pmd-dist-7.8.0-bin.zip
          
          # Verify the installation
          $HOME/pmd-bin-7.8.0/bin/pmd --version

      # Run PMD on HTML files
      - name: Run PMD on HTML files
        continue-on-error: true
        run: |
          $HOME/pmd-bin-7.8.0/bin/pmd check -f text -R .github/rulesets/html.xml -d ./ 2>&1 | tee pmd-html-output.log
          cat pmd-html-output.log
          html_exit_code=$?
          if [ "$html_exit_code" -eq 4 ]; then
            echo "HTML check failed."
          elif [ "$html_exit_code" -ne 0 ]; then
            echo "PMD encountered an error during HTML analysis."
            exit $html_exit_code
          fi

      # Run PMD on JS files
      - name: Run PMD on JS files
        continue-on-error: true
        run: |
          $HOME/pmd-bin-7.8.0/bin/pmd check -f text -R .github/rulesets/js.xml -d ./ 2>&1 | tee pmd-js-output.log
          cat pmd-js-output.log
          js_exit_code=$?
          if [ "$js_exit_code" -eq 4 ]; then
            echo "JS check failed."
          elif [ "$js_exit_code" -ne 0 ]; then
            echo "PMD encountered an error during JS analysis."
            exit $js_exit_code
          fi

      # Final step: Fail if either stage failed
      - name: Check PMD results
        run: |
          html_failed=0
          js_failed=0

          if grep -q "HTML check failed." pmd-html-output.log; then
            html_failed=1
          fi

          if grep -q "JS check failed." pmd-js-output.log; then
            js_failed=1
          fi

          if [ "$html_failed" -eq 0 ] && [ "$js_failed" -eq 0 ]; then
            echo "All PMD checks passed."
          else
            exit 1
          fi